{% extends 'base.html' %}

{% block head %}
<title>Attendance</title>
<style>


  .control-panel { display:flex; gap: 10px; align-items:center; margin: 12px 0; }
  .wrap { padding: 10px 16px; border: 0; border-radius: 8px; background:#334; color:#fff; cursor:pointer; }
  .wrap.secondary { background:#666; }
  .wrap:disabled { opacity: .6; cursor: not-allowed; }
  .status { font: 14px/1.4 system-ui, sans-serif; margin-left: 8px; }

  #stage { position: relative; width: 720px; max-width: 100%; margin: 12px 0; display:none; }
  #cam, #overlay { width: 100%; display: block; }
  #overlay { position:absolute; left:0; top:0; }
</style>
{% endblock %}

{% block body %}
<div class="attendance">
  <!-- Attendance table -->
  <div class="table-wrap">
    <table aria-label="Attendance table">
      <thead>
        <tr>
          <th scope="col">name</th>
          <th scope="col">date</th>
          <th scope="col">status</th>
        </tr>
      </thead>
      <tbody id="att-body">
      </tbody>
    </table>
  </div>

  <div class="control-panel">
    <button id="start-btn" class="wrap">Start</button>
    <button id="stop-btn" class="wrap secondary" disabled>Stop</button>
    <span id="status" class="status"></span>
  </div>

  <div id="stage">
    <video id="cam" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

</div>
<script>
function populateTable(attendanceList) {
    const tbody = document.getElementById('att-body');
    tbody.innerHTML = ''; // Clear existing rows

    attendanceList.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.first_name} ${record.last_name}</td>
            <td>${record.date}</td>
            <td>${record.status_type}</td>
        `;
        tbody.appendChild(row);
    });
}

const STREAM_URL = "http://localhost:8000/face/take_attendance"; 

const startBtn = document.getElementById('start-btn');
const stopBtn  = document.getElementById('stop-btn');
const statusEl = document.getElementById('status');

const stage    = document.getElementById('stage');
const videoEl  = document.getElementById('cam');
const canvasEl = document.getElementById('overlay');

let mediaStream = null;
let captureInterval = null;
let isStreaming = false;

async function startCamera() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    statusEl.textContent = "Camera not supported in this browser.";
    return;
  }

  try {
    statusEl.textContent = "Requesting camera...";
    mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
    videoEl.srcObject = mediaStream;
    stage.style.display = 'block';

    startBtn.disabled = true;
    stopBtn.disabled = false;
    statusEl.textContent = "Camera started. Streaming...";
    isStreaming = true;
    videoEl.onloadedmetadata = () => {
      canvasEl.width  = videoEl.videoWidth;
      canvasEl.height = videoEl.videoHeight;
      startStreaming();
    };
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Failed to access camera.";
  }
}

function stopCamera() {
  isStreaming = false;
  if (captureInterval) {
    clearInterval(captureInterval);
    captureInterval = null;
  }

  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }

  videoEl.srcObject = null;
  stage.style.display = 'none';

  startBtn.disabled = false;
  stopBtn.disabled = true;
  statusEl.textContent = "Camera stopped.";
}
const attendanceList = []

function startStreaming() {
  const ctx = canvasEl.getContext('2d');

  captureInterval = setInterval(() => {
    if (!mediaStream || !isStreaming) return;

    ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);

    canvasEl.toBlob(async (blob) => {
      if (!blob) return;
      try {
       const res =  await fetch(STREAM_URL, {
          method: "POST",
          headers: {
            "Content-Type": "image/jpeg"
          },
          body: blob
        });
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        console.log("resp", data); 
        attendanceList.push(data.attendance)
        populateTable(attendanceList)

      } catch (e) {
        console.error("Stream error:", e);
        statusEl.textContent = "Streaming error (check backend).";
      }
    }, 'image/jpeg', 0.8);
  }, 300);
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);
</script>
{% endblock %}
