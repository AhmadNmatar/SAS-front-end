{% extends 'base.html' %}

{% block head %}
<title>Attendance</title>
<style>
  .attendance { max-width: 960px; margin: 0 auto; }
  .table-wrap { overflow-x:auto; margin: 12px 0; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border-bottom: 1px solid #e5e5e5; padding: 8px 10px; text-align: left; }
  th { text-transform: capitalize; font-weight: 600; }

  .control-panel { display:flex; gap: 10px; align-items:center; margin: 12px 0; }
  .wrap { padding: 10px 16px; border: 0; border-radius: 8px; background:#334; color:#fff; cursor:pointer; }
  .wrap.secondary { background:#666; }
  .wrap:disabled { opacity: .6; cursor: not-allowed; }
  .status { font: 14px/1.4 system-ui, sans-serif; margin-left: 8px; }

  #stage { position: relative; width: 720px; max-width: 100%; margin: 12px 0; display:none; }
  #cam, #overlay { width: 100%; display: block; }
  #overlay { position:absolute; left:0; top:0; }
</style>
{% endblock %}

{% block body %}
<div class="attendance">
  <!-- Attendance table -->
  <div class="table-wrap">
    <table aria-label="Attendance table">
      <thead>
        <tr>
          <th scope="col">name</th>
          <th scope="col">date</th>
          <th scope="col">status</th>
        </tr>
      </thead>
      <tbody id="att-body">
      </tbody>
    </table>
  </div>

    <!-- Controls -->
  <div class="control-panel">
    <button id="start-btn" class="wrap">Start</button>
    <button id="stop-btn" class="wrap secondary" disabled>Stop</button>
    <span id="status" class="status"></span>
  </div>

  <!-- Camera stage -->
  <div id="stage">
    <video id="cam" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

</div>

<script>
function addAttendanceRow(attendance) {
    const tbody = document.getElementById('att-body');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${attendance.first_name} ${attendance.surname}</td>
        <td>${attendance.date}</td>
        <td>${attendance.status}</td>
    `;
    tbody.appendChild(row);
}

// ===== Camera + WebSocket streaming logic =====


const WS_PATH = "/face/take_attendace";

const startBtn = document.getElementById('start-btn');
const stopBtn  = document.getElementById('stop-btn');
const statusEl = document.getElementById('status');

const stage    = document.getElementById('stage');
const videoEl  = document.getElementById('cam');
const canvasEl = document.getElementById('overlay');

document.addEventListener('DOMContentLoaded', function() {
    fetchAttendance();
    setInterval(fetchAttendance, 100);
});

async function fetchAttendance() {
    const backendUrl = '{{ backend_url }}';
    const accessToken = '{{ access_token }}';
    try {
        const response = await fetch(`${backendUrl}/attendance/records`, {
                          method: 'GET',
                          headers: {
                              'Accept': 'application/json',
                              'Authorization': `Bearer ${accessToken}`
                          }
                      });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        populateTable(data);
    } catch (error) {
        console.error('Error fetching attendance:', error);
        // Optionally display error in UI
    }
}

function populateTable(attendanceList) {
    const tbody = document.getElementById('att-body');
    tbody.innerHTML = ''; // Clear existing rows

    attendanceList.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.first_name } ${record.surname}</td>
            <td>${record.date}</td>
            <td>${record.status_type}</td>
        `;
        tbody.appendChild(row);
    });
}

async function starTakingAttendance() {
    const backendUrl = '{{ backend_url }}';
    const accessToken = '{{ access_token }}';
    try {
        const response = await fetch(`${backendUrl}/face/start_recognition`, {
                          method: 'post',
                          headers: {
                              'Accept': 'application/json',
                             // 'Authorization': `Bearer ${accessToken}`
                          }
                      });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
    } catch (error) {
        console.error('Error fetching attendance:', error);
        // Optionally display error in UI
    }
}

startBtn.addEventListener('click', starTakingAttendance);
</script>
{% endblock %}
